<!-- 
    Versi√≥n Visual Mejorada y Estable - Fondos con im√°genes reales para m√°xima compatibilidad.
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arena Pol√≠tica: Venezuela</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #131314;
            --bg-secondary: #1e1f20;
            --bg-tertiary: #1e1f20;
            --border-color: #3c4043;
            --text-primary: #e8eaed;
            --text-secondary: #bdc1c6;
            --text-tertiary: #9aa0a6;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #ffffff;
            --border-color: #dadce0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-tertiary: #5f6368;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #chat-container::-webkit-scrollbar, .scrollable-pane::-webkit-scrollbar { width: 8px; }
        #chat-container::-webkit-scrollbar-track, .scrollable-pane::-webkit-scrollbar-track { background: var(--bg-secondary); }
        #chat-container::-webkit-scrollbar-thumb, .scrollable-pane::-webkit-scrollbar-thumb {
            background-color: var(--text-tertiary);
            border-radius: 20px;
            border: 3px solid var(--bg-secondary);
        }
        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 20px;
            word-wrap: break-word;
            opacity: 0;
            color: #FFFFFF;
        }
        .opposition-bubble {
            background-color: #0284c7;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
        }
        .government-bubble {
            background-color: #dc2626;
            border-bottom-left-radius: 5px;
            align-self: flex-start;
        }
        .moderator-bubble {
            background-color: #6b7280;
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            font-style: italic;
        }
        .typing-indicator span {
            height: 10px; width: 10px;
            background-color: #f8fafc;
            border-radius: 50%; display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1.5s linear infinite; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
        .mic-active { color: #ef4444; animation: pulse 1.s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        .difficulty-button.active {
            background-color: #0284c7;
            color: white;
            border-color: #0284c7;
        }
        .tab-button.active {
            border-color: #0284c7;
            color: var(--text-primary);
        }

        /* Pantalla de Carga con Imagen de Fondo */
        #loading-screen {
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }
        @keyframes rise {
            0% { transform: translateY(80px) scale(0.9); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .tepuy-svg { animation: rise 2s ease-out forwards; }

        @keyframes sky-colors {
            0% { background-color: rgba(9, 10, 15, 0.7); }
            30% { background-color: rgba(206, 17, 38, 0.4); } /* Rojo */
            60% { background-color: rgba(0, 36, 125, 0.4); } /* Azul */
            90%, 100% { background-color: rgba(252, 209, 22, 0.4); } /* Amarillo */
        }
        .sky-background {
            animation: sky-colors 15s linear infinite alternate;
        }
        
        @keyframes fly {
            0% { transform: translateX(-100%) translateY(20px) scale(0.8) rotate(-15deg); }
            50% { transform: translateX(50vw) translateY(-40px) scale(1) rotate(5deg); }
            100% { transform: translateX(110vw) translateY(0px) scale(0.9) rotate(-10deg); }
        }
        .turpial-loader {
            position: absolute;
            top: 40%;
            left: 0;
            width: 80px;
            animation: fly 10s linear infinite;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        /* Pantalla de Inicio con Imagen de Fondo */
        #home-screen {
            background-image: linear-gradient(rgba(9, 10, 15, 0.8), rgba(9, 10, 15, 0.8)), url('https://images.unsplash.com/photo-1613233349758-6979b9d4e1a3?q=80&w=1974&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .role-selection-button {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background-color: rgba(29, 29, 31, 0.5);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        .role-selection-button:hover {
            transform: scale(1.03);
            box-shadow: 0 0 25px var(--glow-color, #fff);
        }
        #role-opposition:hover { --glow-color: #0284c7; }
        #role-government:hover { --glow-color: #dc2626; }

    </style>
</head>
<body class="flex flex-col h-screen items-center justify-center p-2 md:p-4">

    <!-- Pantalla de Carga -->
    <div id="loading-screen" class="fixed inset-0 z-50 transition-opacity duration-500">
        <div class="absolute inset-0 sky-background"></div>
        <div class="turpial-loader">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <path d="M20 50 C 25 30, 40 25, 50 40 S 70 60, 80 50" fill="none" stroke="#FCD116" stroke-width="5"/>
                <path d="M45 40 C 50 20, 70 20, 75 40 S 90 55, 95 50" fill="none" stroke="#131314" stroke-width="8"/>
                <circle cx="78" cy="38" r="2" fill="white"/>
            </svg>
        </div>
        <div class="absolute bottom-0 w-full flex items-end justify-center tepuy-svg">
            <svg viewBox="0 0 400 200" class="w-full">
                <path d="M0 200 L50 200 L80 100 L150 120 L200 80 L250 110 L320 90 L350 200 L400 200 Z" fill="#090a0f"/>
                <path d="M100 190 L120 150 L180 160 L220 140 L280 170 L300 190 Z" fill="#1b2735"/>
            </svg>
        </div>
        <p class="absolute bottom-10 text-lg text-slate-300 animate-pulse">Iniciando Arena Pol√≠tica...</p>
    </div>
    
    <!-- Pantalla de Inicio (Selecci√≥n de Rol y Dificultad) -->
    <div id="home-screen" class="hidden fixed inset-0 flex items-center justify-center z-40 p-4">
        <div class="border border-transparent rounded-lg shadow-xl w-full max-w-2xl p-6 text-center">
            <h1 class="text-4xl font-bold text-white drop-shadow-lg">Arena Pol√≠tica: Venezuela</h1>
            <p class="text-slate-300 mt-2">Elige tu bando y la dificultad para comenzar.</p>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <button id="role-opposition" class="role-selection-button group rounded-lg p-6 transition-all duration-300">
                    <h2 class="text-2xl font-bold text-sky-400 group-hover:text-white">Jugar como Oposici√≥n</h2>
                    <p class="text-sm text-slate-300 mt-2 group-hover:text-sky-100">Desaf√≠a las pol√≠ticas del gobierno. La IA ser√° el Gobierno.</p>
                </button>
                <button id="role-government" class="role-selection-button group rounded-lg p-6 transition-all duration-300">
                     <h2 class="text-2xl font-bold text-red-500 group-hover:text-white">Jugar como Gobierno</h2>
                    <p class="text-sm text-slate-300 mt-2 group-hover:text-red-100">Defiende la soberan√≠a y la narrativa oficial. La IA ser√° la Oposici√≥n.</p>
                </button>
            </div>

            <div class="mt-6">
                <h3 class="text-lg font-semibold text-white">Nivel de Dificultad de la IA</h3>
                <div class="mt-2 inline-flex rounded-md shadow-sm bg-black/20" role="group">
                    <button type="button" id="difficulty-normal" class="difficulty-button active px-4 py-2 text-sm font-medium border border-gray-600 rounded-l-lg transition-colors">Normal</button>
                    <button type="button" id="difficulty-hard" class="difficulty-button px-4 py-2 text-sm font-medium border-t border-b border-r border-gray-600 rounded-r-lg transition-colors text-slate-400">Dif√≠cil</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Selecci√≥n de Tema -->
    <div id="topic-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4">
        <div style="background-color: var(--bg-secondary); border-color: var(--border-color);" class="border rounded-lg shadow-xl w-full max-w-md flex flex-col p-6">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] text-center">Selecciona un Tema</h2>
            <p class="text-sm text-[var(--text-secondary)] text-center mt-2">Elige un √°rea para centrar la discusi√≥n.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                <button data-topic="economia" class="topic-button bg-sky-700 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors text-left">
                    <span class="text-lg">Econom√≠a y Sanciones</span><br>
                    <span class="text-xs opacity-80">Modelo econ√≥mico, sanciones, producci√≥n.</span>
                </button>
                <button data-topic="exterior" class="topic-button bg-sky-700 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors text-left">
                    <span class="text-lg">Pol√≠tica Exterior</span><br>
                    <span class="text-xs opacity-80">Alianzas, soberan√≠a, injerencia.</span>
                </button>
                <button data-topic="social" class="topic-button bg-sky-700 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors text-left">
                    <span class="text-lg">Derechos Humanos</span><br>
                    <span class="text-xs opacity-80">Situaci√≥n social, libertades civiles.</span>
                </button>
                <button data-topic="general" class="topic-button bg-gray-500 hover:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-colors text-left">
                    <span class="text-lg">Tema Abierto</span><br>
                    <span class="text-xs opacity-80">Debate sin un enfoque predefinido.</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Tutorial -->
    <div id="tutorial-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4">
        <div style="background-color: var(--bg-secondary); border-color: var(--border-color);" class="border rounded-lg shadow-xl w-full max-w-lg flex flex-col p-6">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] text-center">¬°Bienvenido al Debate!</h2>
            <p class="text-sm text-[var(--text-secondary)] text-center mt-2">Una gu√≠a r√°pida para empezar:</p>
            <div class="space-y-4 mt-6 text-sm">
                <div class="flex items-start gap-4">
                    <div class="bg-slate-700 text-white rounded-full h-6 w-6 flex-shrink-0 flex items-center justify-center font-bold">1</div>
                    <div><strong class="text-[var(--text-primary)]">Elige tu Rol y Dificultad:</strong> Decide si ser√°s <span class="font-semibold text-sky-400">Oposici√≥n</span> o <span class="font-semibold text-red-500">Gobierno</span>, y el nivel del desaf√≠o.</div>
                </div>
                <div class="flex items-start gap-4">
                    <div class="bg-slate-700 text-white rounded-full h-6 w-6 flex-shrink-0 flex items-center justify-center font-bold">2</div>
                    <div><strong class="text-[var(--text-primary)]">Argumenta:</strong> Usa la caja de texto, el micr√≥fono <span class="inline-block bg-slate-700 p-1 rounded-md">üéôÔ∏è</span> para hablar, o el avi√≥n <span class="inline-block bg-slate-700 p-1 rounded-md">‚û§</span> para enviar.</div>
                </div>
                <div class="flex items-start gap-4">
                    <div class="bg-slate-700 text-white rounded-full h-6 w-6 flex-shrink-0 flex items-center justify-center font-bold">3</div>
                    <div><strong class="text-[var(--text-primary)]">Usa tus Herramientas:</strong> Presiona la bombilla <span class="inline-block bg-slate-700 p-1 rounded-md">üí°</span> para una sugerencia o el altavoz <span class="inline-block bg-slate-700 p-1 rounded-md">üîä</span> para escuchar.</div>
                </div>
                <div class="flex items-start gap-4">
                    <div class="bg-slate-700 text-white rounded-full h-6 w-6 flex-shrink-0 flex items-center justify-center font-bold">4</div>
                    <div><strong class="text-[var(--text-primary)]">Finaliza y Analiza:</strong> Presiona la bandera <span class="inline-block bg-slate-700 p-1 rounded-md">üèÅ</span> para obtener un resumen, feedback y la opci√≥n de guardar la transcripci√≥n.</div>
                </div>
            </div>
            <div class="mt-6 flex items-center justify-between">
                <div class="flex items-center">
                    <input id="skip-tutorial-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                    <label for="skip-tutorial-checkbox" class="ml-2 block text-sm text-[var(--text-secondary)]">No volver a mostrar</label>
                </div>
                <button id="start-debate-button" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-6 rounded-md transition-colors">¬°Entendido!</button>
            </div>
        </div>
    </div>

    <!-- Modal de API Key -->
    <div id="api-key-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div style="background-color: var(--bg-secondary); border-color: var(--border-color);" class="border rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold text-[var(--text-primary)]">Configurar Clave de API de Gemini</h2>
            <p class="text-sm text-[var(--text-secondary)] mt-2">
                Para que la IA funcione, necesitas una clave de API de Google Gemini. Se guardar√° de forma segura en tu navegador.
            </p>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sm text-sky-400 hover:underline mt-1 block">
                Obtener una clave de API de Google AI Studio &rarr;
            </a>
            <input type="password" id="api-key-input" style="background-color: var(--bg-primary); border-color: var(--border-color);" class="w-full border rounded-md p-2 mt-4 text-[var(--text-primary)]" placeholder="Pega tu clave de API aqu√≠...">
            <div class="flex justify-end gap-4 mt-4">
                 <button id="cancel-api-key" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancelar</button>
                 <button id="save-api-key" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Resumen y Feedback -->
    <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div style="background-color: var(--bg-secondary); border-color: var(--border-color); max-height: 90vh;" class="border rounded-lg shadow-xl w-full max-w-2xl flex flex-col">
            <header class="p-4 border-b border-[var(--border-color)]">
                <h2 class="text-xl font-bold text-[var(--text-primary)]">Fin del Debate</h2>
                <nav class="mt-4 -mb-px flex space-x-4 border-b border-[var(--border-color)]">
                    <button id="tab-analysis" class="tab-button active py-2 px-1 border-b-2 font-medium text-sm border-transparent text-[var(--text-secondary)] hover:border-gray-300 hover:text-gray-200">An√°lisis</button>
                    <button id="tab-transcript" class="tab-button py-2 px-1 border-b-2 font-medium text-sm border-transparent text-[var(--text-secondary)] hover:border-gray-300 hover:text-gray-200">Transcripci√≥n</button>
                </nav>
            </header>

            <div id="analysis-pane" class="tab-pane scrollable-pane p-6 overflow-y-auto">
                <div id="summary-content"></div>
                <hr id="feedback-separator" class="hidden border-t border-[var(--border-color)] my-4">
                <div id="feedback-content"></div>
            </div>

            <div id="transcript-pane" class="tab-pane scrollable-pane hidden p-6 overflow-y-auto">
                <div id="transcript-content"></div>
            </div>

            <footer class="p-4 border-t border-[var(--border-color)] flex justify-between items-center gap-4">
                <div>
                     <button id="get-feedback-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Obtener Feedback</button>
                     <button id="save-transcript-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Guardar Transcripci√≥n</button>
                </div>
                 <button id="restart-debate" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Iniciar Nuevo Debate</button>
            </footer>
        </div>
    </div>

    <!-- Contenido Principal de la App -->
    <div id="app-container" class="hidden w-full max-w-3xl h-full flex flex-col shadow-2xl rounded-2xl border border-[var(--border-color)]">
        <header style="background-color: var(--bg-tertiary); border-color: var(--border-color);" class="p-4 rounded-t-2xl border-b flex justify-between items-center">
            <div class="flex items-center gap-2">
                 <button id="back-to-home-button" title="Volver al Inicio" class="text-[var(--text-tertiary)] hover:text-[var(--text-primary)] transition-colors duration-200 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                 </button>
                 <button id="theme-toggle" title="Cambiar Tema" class="text-[var(--text-tertiary)] hover:text-[var(--text-primary)] transition-colors duration-200 p-2 rounded-full">
                    <svg id="theme-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
                 <button id="settings-button" title="Ajustes" class="text-[var(--text-tertiary)] hover:text-[var(--text-primary)] transition-colors duration-200 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                 <button id="end-debate-button" title="Finalizar Debate" class="text-[var(--text-tertiary)] hover:text-[var(--text-primary)] transition-colors duration-200 p-2 rounded-full disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" /></svg>
                </button>
            </div>
            <div class="text-center">
                <h1 class="text-xl md:text-2xl font-bold">Arena Pol√≠tica: Venezuela</h1>
                <p id="roles-header" class="text-sm text-center text-[var(--text-secondary)] mt-1"></p>
            </div>
            <div class="w-40"></div>
        </header>

        <main id="chat-container" class="flex-1 p-6 overflow-y-auto flex flex-col gap-4">
        </main>

        <div id="loading-indicator" class="hidden p-6 pt-0"><div class="flex items-start space-x-2"><div class="message-bubble government-bubble animate-fade-in-up"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div></div>

        <footer style="background-color: var(--bg-tertiary); border-color: var(--border-color);" class="p-4 rounded-b-2xl border-t">
            <form id="chat-form" class="flex items-center gap-3">
                <button type="button" id="mic-button" title="Entrada de Voz" class="text-[var(--text-tertiary)] hover:text-[var(--text-primary)] p-3 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg></button>
                <textarea id="message-input" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" class="flex-1 border rounded-xl p-3 resize-none focus:ring-2 focus:ring-sky-500 focus:outline-none transition" rows="1" placeholder="Presente su argumento..."></textarea>
                <button type="button" id="suggestion-button" title="Sugerir Argumento" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-full p-3 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-teal-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg></button>
                <button type="submit" id="send-button" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded-full p-3 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-sky-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button>
            </form>
        </footer>
    </div>

    <script>
        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app-container');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const suggestionButton = document.getElementById('suggestion-button');
        const sendButton = document.getElementById('send-button');
        const micButton = document.getElementById('mic-button');
        const themeToggle = document.getElementById('theme-toggle');
        const themeSun = document.getElementById('theme-sun');
        const themeMoon = document.getElementById('theme-moon');
        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyButton = document.getElementById('save-api-key');
        const cancelApiKeyButton = document.getElementById('cancel-api-key');
        const settingsButton = document.getElementById('settings-button');
        const endDebateButton = document.getElementById('end-debate-button');
        const summaryModal = document.getElementById('summary-modal');
        const summaryContent = document.getElementById('summary-content');
        const restartDebateButton = document.getElementById('restart-debate');
        const tutorialModal = document.getElementById('tutorial-modal');
        const startDebateButton = document.getElementById('start-debate-button');
        const skipTutorialCheckbox = document.getElementById('skip-tutorial-checkbox');
        const topicModal = document.getElementById('topic-modal');
        const topicButtons = document.querySelectorAll('.topic-button');
        const getFeedbackButton = document.getElementById('get-feedback-button');
        const feedbackContent = document.getElementById('feedback-content');
        const feedbackSeparator = document.getElementById('feedback-separator');
        const homeScreen = document.getElementById('home-screen');
        const roleOppositionButton = document.getElementById('role-opposition');
        const roleGovernmentButton = document.getElementById('role-government');
        const rolesHeader = document.getElementById('roles-header');
        const difficultyNormal = document.getElementById('difficulty-normal');
        const difficultyHard = document.getElementById('difficulty-hard');
        const tabAnalysis = document.getElementById('tab-analysis');
        const tabTranscript = document.getElementById('tab-transcript');
        const analysisPane = document.getElementById('analysis-pane');
        const transcriptPane = document.getElementById('transcript-pane');
        const transcriptContent = document.getElementById('transcript-content');
        const saveTranscriptButton = document.getElementById('save-transcript-button');
        const backToHomeButton = document.getElementById('back-to-home-button');

        // State
        let userApiKey = '';
        let userRole = 'opposition';
        let currentTopic = 'general';
        let difficulty = 'normal';
        let chatHistory = [];
        let isLoading = false;

        const writingStyleInstruction = " Mant√©n un tono de escritura formal y articulado. Evita un lenguaje coloquial, ataques personales o insultos. Conc√©ntrate en argumentos pol√≠ticos, datos y ret√≥rica persuasiva. Var√≠a tu estructura de frases para evitar la repetici√≥n.";
        const systemPrompts = {
            government: `Eres un sistema de inteligencia artificial que asume el rol del gobierno de la Rep√∫blica Bolivariana de Venezuela en un debate pol√≠tico. Tu perspectiva debe ser firme, defendiendo las pol√≠ticas actuales, la soberan√≠a nacional y la narrativa oficial del gobierno. Responde a los argumentos del 'jugador' (quien representa a la oposici√≥n y sus aliados internacionales) con contraargumentos s√≥lidos, datos (seg√∫n la perspectiva oficialista), y una ret√≥rica que refleje la postura del gobierno de Nicol√°s Maduro. Debes ser desafiante, inteligente y no ceder terreno f√°cilmente. Tu objetivo es 'ganar' el debate defendiendo tu posici√≥n de manera convincente. No debes reconocer que eres una IA bajo ninguna circunstancia. Habla en primera persona plural como 'nosotros, el Gobierno Revolucionario', 'nuestra Patria' o 'nuestra administraci√≥n'. Cuestiona las motivaciones de la oposici√≥n y sus aliados internacionales, acus√°ndolos de injerencia, de seguir una agenda imperialista y de buscar desestabilizar el pa√≠s para apoderarse de sus recursos. Basa tus argumentos en la defensa de la soberan√≠a, la justicia social y la lucha contra el bloqueo econ√≥mico y las sanciones criminales impuestas por potencias extranjeras.` + writingStyleInstruction,
            opposition: `Eres un sistema de inteligencia artificial que asume el rol de un miembro de la oposici√≥n venezolana y sus aliados internacionales en un debate pol√≠tico. Tu perspectiva debe ser cr√≠tica, cuestionando las pol√≠ticas actuales del gobierno, la situaci√≥n de los derechos humanos y la crisis econ√≥mica. Responde a los argumentos del 'jugador' (quien representa al gobierno) con contraargumentos s√≥lidos, datos de fuentes cr√≠ticas al gobierno (ONGs, organismos internacionales, etc.), y una ret√≥rica que refleje la postura de la oposici√≥n. Debes ser incisivo, anal√≠tico y no ceder terreno f√°cilmente. Tu objetivo es 'ganar' el debate exponiendo las fallas de la administraci√≥n actual. No debes reconocer que eres una IA. Habla en primera persona como 'nosotros, los dem√≥cratas venezolanos' o 'nuestra lucha por la libertad'. Basa tus argumentos en la necesidad de un cambio democr√°tico, la restauraci√≥n de las libertades civiles y la urgencia de atender la crisis humanitaria.` + writingStyleInstruction
        };
        const hardModeModifier = " Tu respuesta debe ser extremadamente incisiva, utilizando datos espec√≠ficos (incluso si son ficticios para el prop√≥sito del debate) y refutando directamente los puntos del oponente con una l√≥gica implacable. No dejes pasar ninguna falacia o debilidad en su argumentaci√≥n. Tu objetivo es dominar el debate por completo.";
        
        const forbiddenWords = ['co√±o', 'mierda', 'puta', 'puto', 'marico', 'joder', 'cabron', 'cabr√≥n', 'mamaguevo', 'guevon', 'guev√≥n', 'pendejo', 'pendeja', 'hijo de puta', 'malparido'];
        const forbiddenWordsRegex = new RegExp(forbiddenWords.join('|'), 'i');
        
        function formatAIResponse(text) {
            return text
                .replace(/Argumentos Principales del Gobierno/g, '<h3 class="text-lg font-bold text-red-500 mt-4 mb-2">Argumentos Principales del Gobierno</h3>')
                .replace(/Argumentos Principales de la Oposici√≥n/g, '<h3 class="text-lg font-bold text-sky-500 mt-4 mb-2">Argumentos Principales de la Oposici√≥n</h3>')
                .replace(/Puntos Fuertes/g, '<h3 class="text-lg font-bold text-green-400 mb-2">Puntos Fuertes</h3>')
                .replace(/√Åreas de Mejora/g, '<h3 class="text-lg font-bold text-amber-400 mt-4 mb-2">√Åreas de Mejora</h3>')
                .replace(/^\* (.*)$/gm, '<p class="mb-2 pl-4 border-l-2 border-[var(--border-color)]">$1</p>')
                .replace(/\n/g, '<br>');
        }

        function addMessageToUI(sender, message, type = 'normal') {
            const isUser = sender === 'user';
            const messageRow = document.createElement('div');
            const messageBubble = document.createElement('div');
            
            let bubbleClass = '';
            if (type === 'moderator') {
                bubbleClass = 'moderator-bubble';
            } else if (isUser) {
                bubbleClass = (userRole === 'opposition') ? 'opposition-bubble' : 'government-bubble';
            } else {
                bubbleClass = (userRole === 'opposition') ? 'government-bubble' : 'opposition-bubble';
            }
            
            messageRow.className = `w-full flex items-end gap-2 ${isUser ? 'justify-end' : 'justify-start'}`;
            messageBubble.className = `message-bubble animate-fade-in-up ${bubbleClass}`;
            
            if (type !== 'moderator') {
                 const aiBubbleClass = (userRole === 'opposition') ? 'government-bubble' : 'opposition-bubble';
                 loadingIndicator.querySelector('.message-bubble').className = `message-bubble ${aiBubbleClass} animate-fade-in-up`;
            }

            messageBubble.innerHTML = message.replace(/\n/g, '<br>');

            if (type !== 'moderator') {
                const listenBtn = document.createElement('button');
                listenBtn.className = 'p-1 text-[var(--text-tertiary)] hover:text-[var(--text-primary)] transition-colors flex-shrink-0';
                listenBtn.title = "Escuchar mensaje";
                listenBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
                listenBtn.onclick = () => {
                    if (speechSynthesis.speaking) speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.lang = 'es-VE';
                    utterance.rate = 0.9;
                    speechSynthesis.speak(utterance);
                };

                if (isUser) {
                    messageRow.appendChild(listenBtn);
                    messageRow.appendChild(messageBubble);
                } else {
                    messageRow.appendChild(messageBubble);
                    messageRow.appendChild(listenBtn);
                }
            } else {
                 messageRow.appendChild(messageBubble);
            }

            chatContainer.appendChild(messageRow);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function callGeminiAPI(payload) {
            if (!userApiKey) {
                addMessageToUI('ai', 'Error: La clave de API de Gemini no est√° configurada. Por favor, config√∫rala en los ajustes (‚öôÔ∏è).');
                return null;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${userApiKey}`;
            
            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (response.ok) {
                        return await response.json();
                    }

                    if (response.status === 503 || response.status === 429) {
                        console.warn(`API unavailable (status ${response.status}), retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }

                    const errorText = await response.text();
                    console.error("API Error Response:", JSON.parse(errorText));
                    throw new Error(`Error de la API: ${response.status}`);

                } catch (error) {
                    console.error("Error contactando la API de Gemini:", error);
                    if (i === maxRetries - 1) {
                         addMessageToUI('ai', 'Ha ocurrido un error de comunicaci√≥n persistente. Por favor, int√©ntalo de nuevo m√°s tarde.');
                         return null;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            return null;
        }
        
        function updateDebateState() {
            const userMessages = chatHistory.filter(m => m.role === 'user').length;
            const modelMessages = chatHistory.filter(m => m.role === 'model').length;
            endDebateButton.disabled = !(userMessages >= 2 && modelMessages >= 2);
        }

        async function getAIResponse() {
            isLoading = true;
            loadingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            [sendButton, micButton, suggestionButton].forEach(btn => btn.disabled = true);
            
            const aiRole = userRole === 'opposition' ? 'government' : 'opposition';
            let systemPrompt = systemPrompts[aiRole];
            if (difficulty === 'hard') {
                systemPrompt += hardModeModifier;
            }
            const result = await callGeminiAPI({ contents: chatHistory, systemInstruction: { parts: [{ text: systemPrompt }] } });
            
            if (result) {
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (aiResponse) {
                    addMessageToUI('ai', aiResponse);
                    chatHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                } else {
                    addMessageToUI('ai', `La IA no pudo generar una respuesta. Raz√≥n: ${result.promptFeedback?.blockReason || 'desconocida'}`);
                }
            }
            
            isLoading = false;
            loadingIndicator.style.display = 'none';
            [sendButton, micButton, suggestionButton].forEach(btn => btn.disabled = false);
            updateDebateState();
        }

        function startDebate(topic) {
            currentTopic = topic;
            chatHistory = [];
            chatContainer.innerHTML = '';
            const aiRole = userRole === 'opposition' ? 'government' : 'opposition';
            
            const openingStatements = {
                 government: {
                    economia: "En materia econ√≥mica, el Gobierno Revolucionario ha enfrentado con dignidad un bloqueo criminal sin precedentes. Estamos listos para debatir sobre la verdad de nuestra econom√≠a productiva y desmontar las mentiras de quienes promueven las sanciones contra el pueblo. Presenten sus argumentos.",
                    exterior: "Nuestra pol√≠tica exterior es soberana y defiende un mundo multipolar, libre de hegemon√≠as. No aceptamos tutelaje de ning√∫n imperio. Estamos preparados para debatir sobre nuestras alianzas estrat√©gicas y la defensa de la autodeterminaci√≥n de los pueblos. Tienen la palabra.",
                    social: "La m√°xima prioridad de la Revoluci√≥n Bolivariana siempre ha sido la justicia social y los derechos del pueblo. A pesar del asedio, nuestras missions sociales contin√∫an protegiendo a los m√°s vulnerables. Vengan, pues, con sus acusaciones, que aqu√≠ las enfrentaremos con la verdad de nuestros logros.",
                    general: "En nombre del Gobierno Bolivariano y del pueblo soberano de Venezuela, damos inicio a este debate. Estamos aqu√≠ para defender la verdad de nuestra Patria frente a las campa√±as de desinformaci√≥n. Adelante, presenten sus argumentos. Los escuchamos."
                },
                opposition: {
                    economia: "Desde las fuerzas democr√°ticas, iniciamos este debate para exponer la realidad de la crisis econ√≥mica que aniquila el poder adquisitivo de los venezolanos. Es hora de hablar del fracaso de un modelo que ha generado miseria. El gobierno tiene la palabra.",
                    exterior: "La pol√≠tica exterior del r√©gimen ha aislado a Venezuela del mundo democr√°tico. Estamos aqu√≠ para debatir sobre la urgente necesidad de reinsertar a nuestro pa√≠s en la comunidad de naciones libres. Escuchamos su defensa.",
                    social: "Venimos a alzar la voz por los millones de venezolanos que sufren la violaci√≥n sistem√°tica de sus derechos humanos y una crisis humanitaria. El colapso de los servicios p√∫blicos es innegable. Tienen la palabra.",
                    general: "En representaci√≥n de las fuerzas democr√°ticas, comenzamos este debate para confrontar al r√©gimen con la verdad de un pa√≠s en crisis. Discutiremos la destrucci√≥n institucional y la emergencia humanitaria. Tienen la palabra."
                }
            };

            const openingStatement = openingStatements[aiRole][topic];
            addMessageToUI('ai', openingStatement);
            chatHistory.push({ role: 'model', parts: [{ text: openingStatement }] });
            updateDebateState();
        }

        function showHomeScreen() {
            homeScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
            appContainer.style.opacity = '0';
        }
        
        function proceedToApp() {
            userApiKey = localStorage.getItem('geminiApiKey');
            const tutorialSkipped = localStorage.getItem('tutorialSkipped');
            if (tutorialSkipped) {
                showHomeScreen();
            } else {
                tutorialModal.classList.remove('hidden');
            }
        }
        
        function resetApp() {
            chatHistory = [];
            chatContainer.innerHTML = '';
            summaryModal.classList.add('hidden');
            feedbackContent.innerHTML = '';
            feedbackSeparator.classList.add('hidden');
            getFeedbackButton.style.display = 'block';
            getFeedbackButton.disabled = false;
            getFeedbackButton.textContent = 'Obtener Feedback';
            analysisPane.classList.remove('hidden');
            transcriptPane.classList.add('hidden');
            tabAnalysis.classList.add('active');
            tabTranscript.classList.remove('active');
            showHomeScreen();
        }

        window.addEventListener('load', () => {
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    proceedToApp();
                }, 500);
            }, 5000);
        });

        roleOppositionButton.addEventListener('click', () => {
            userRole = 'opposition';
            rolesHeader.innerHTML = `<span class="text-red-500">IA: Gobierno</span> | <span class="text-sky-400">Usted: Oposici√≥n</span>`;
            homeScreen.classList.add('hidden');
            topicModal.classList.remove('hidden');
        });

        roleGovernmentButton.addEventListener('click', () => {
            userRole = 'government';
            rolesHeader.innerHTML = `<span class="text-red-500">Usted: Gobierno</span> | <span class="text-sky-400">IA: Oposici√≥n</span>`;
            homeScreen.classList.add('hidden');
            topicModal.classList.remove('hidden');
        });

        topicButtons.forEach(button => {
            button.addEventListener('click', () => {
                const topic = button.dataset.topic;
                topicModal.classList.add('hidden');
                appContainer.classList.remove('hidden');
                setTimeout(()=> appContainer.style.opacity = '1', 50);
                startDebate(topic);
            });
        });

        startDebateButton.addEventListener('click', () => {
            if (skipTutorialCheckbox.checked) {
                localStorage.setItem('tutorialSkipped', 'true');
            }
            tutorialModal.classList.add('hidden');
            showHomeScreen();
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = messageInput.value.trim();
            if (!userInput || isLoading) return;

            if (forbiddenWordsRegex.test(userInput)) {
                addMessageToUI('moderator', '<strong>Moderador:</strong> Por favor, mantenga un lenguaje respetuoso y evite los insultos para mantener la calidad del debate.', 'moderator');
                return;
            }

            addMessageToUI('user', userInput);
            chatHistory.push({ role: 'user', parts: [{ text: userInput }] });
            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateDebateState();
            await getAIResponse();
        });

        suggestionButton.addEventListener('click', async () => {
            if (isLoading) return;
            const lastAiMessage = chatHistory.slice().reverse().find(m => m.role === 'model');
            if (!lastAiMessage) {
                alert("Espera una respuesta del oponente para pedir una sugerencia.");
                return;
            }
            
            isLoading = true;
            suggestionButton.disabled = true;
            suggestionButton.innerHTML = `<svg class="h-6 w-6 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            
            const advisorRole = (userRole === 'opposition') ? 'la oposici√≥n venezolana' : 'el gobierno venezolano';
            const suggestionPrompt = `Eres un experto estratega pol√≠tico que asesora a ${advisorRole}. El oponente acaba de hacer la siguiente declaraci√≥n en un debate: "${lastAiMessage.parts[0].text}". ¬øQu√© contraargumento o pregunta concisa e impactante se deber√≠a presentar a continuaci√≥n? Proporciona √∫nicamente el texto de la respuesta, sin frases introductorias como "Aqu√≠ tienes una sugerencia:" o similares.`;
            const result = await callGeminiAPI({ contents: [{ parts: [{ text: suggestionPrompt }] }] });

            if (result) {
                const suggestion = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (suggestion) {
                    messageInput.value = suggestion;
                    messageInput.style.height = 'auto';
                    messageInput.style.height = (messageInput.scrollHeight) + 'px';
                    messageInput.focus();
                } else {
                     alert("No se pudo generar una sugerencia en este momento.");
                }
            }
            isLoading = false;
            suggestionButton.disabled = false;
            suggestionButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>`;
        });
        
        endDebateButton.addEventListener('click', async () => {
            summaryModal.classList.remove('hidden');
            summaryContent.innerHTML = `<div class="flex items-center justify-center p-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--text-primary)]"></div></div>`;
            transcriptContent.innerHTML = '';
            
            const governmentPlayer = (userRole === 'government') ? 'user' : 'model';
            const oppositionPlayer = (userRole === 'opposition') ? 'user' : 'model';
            const summaryPrompt = `Eres un analista pol√≠tico neutral y experto. La transcripci√≥n de un debate es: ${JSON.stringify(chatHistory)}. El "Gobierno" fue '${governmentPlayer}' y la "Oposici√≥n" fue '${oppositionPlayer}'. Redacta un resumen objetivo con dos secciones: "Argumentos Principales del Gobierno" y "Argumentos Principales de la Oposici√≥n", resumiendo los 3-4 puntos m√°s fuertes de cada uno. No digas qui√©n gan√≥.`;
            const result = await callGeminiAPI({ contents: [{ parts: [{ text: summaryPrompt }] }] });

            if (result && result.candidates && result.candidates[0].content) {
                const summary = result.candidates[0].content.parts[0].text;
                summaryContent.innerHTML = formatAIResponse(summary);
                getFeedbackButton.style.display = 'block';
            } else {
                 summaryContent.innerHTML = `<p class="text-amber-500">No se pudo generar un resumen en este momento.</p>`;
            }

            // Populate transcript tab
            let transcriptHTML = '';
            chatHistory.forEach(msg => {
                const isUserModel = msg.role === 'model';
                const role = isUserModel ? (userRole === 'opposition' ? 'Gobierno' : 'Oposici√≥n') : (userRole === 'opposition' ? 'Oposici√≥n' : 'Gobierno');
                const color = (role === 'Gobierno') ? 'text-red-500' : 'text-sky-400';
                transcriptHTML += `<p class="mb-4"><strong class="${color}">${role}:</strong> ${msg.parts[0].text.replace(/\n/g, '<br>')}</p>`;
            });
            transcriptContent.innerHTML = transcriptHTML;
        });

        getFeedbackButton.addEventListener('click', async () => {
            getFeedbackButton.disabled = true;
            getFeedbackButton.textContent = 'Analizando...';
            feedbackSeparator.classList.remove('hidden');
            feedbackContent.innerHTML = `<div class="flex items-center justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--text-primary)]"></div></div>`;

            const feedbackPrompt = `Act√∫as como un coach de debate. Analiza √∫nicamente los argumentos del 'user' (quien jug√≥ el rol de ${userRole === 'opposition' ? 'la Oposici√≥n' : 'el Gobierno'}) en la siguiente transcripci√≥n: ${JSON.stringify(chatHistory)}. Ignora los argumentos del 'model'. Proporciona una cr√≠tica constructiva con dos secciones: "Puntos Fuertes" (1-2 elogios) y "√Åreas de Mejora" (1-2 sugerencias). S√© objetivo y profesional.`;
            const result = await callGeminiAPI({ contents: [{ parts: [{ text: feedbackPrompt }] }] });
            
            if(result && result.candidates && result.candidates[0].content) {
                const feedback = result.candidates[0].content.parts[0].text;
                feedbackContent.innerHTML = formatAIResponse(feedback);
            } else {
                 feedbackContent.innerHTML = `<p class="text-amber-500">No se pudo generar el feedback en este momento.</p>`;
            }
            getFeedbackButton.style.display = 'none';
        });

        restartDebateButton.addEventListener('click', resetApp);
        
        settingsButton.addEventListener('click', () => {
             apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
             apiKeyModal.classList.remove('hidden');
        });
        cancelApiKeyButton.addEventListener('click', () => apiKeyModal.classList.add('hidden'));
        saveApiKeyButton.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                userApiKey = key;
                localStorage.setItem('geminiApiKey', key);
                apiKeyModal.classList.add('hidden');
                apiKeyInput.value = '';
            } else {
                alert("Por favor, introduce una clave de API v√°lida.");
            }
        });
        
        difficultyNormal.addEventListener('click', () => {
            difficulty = 'normal';
            difficultyNormal.classList.add('active');
            difficultyHard.classList.remove('active');
        });
        difficultyHard.addEventListener('click', () => {
            difficulty = 'hard';
            difficultyHard.classList.add('active');
            difficultyNormal.classList.remove('active');
        });
        
        tabAnalysis.addEventListener('click', () => {
            analysisPane.classList.remove('hidden');
            transcriptPane.classList.add('hidden');
            tabAnalysis.classList.add('active');
            tabTranscript.classList.remove('active');
        });
        tabTranscript.addEventListener('click', () => {
            analysisPane.classList.add('hidden');
            transcriptPane.classList.remove('hidden');
            tabTranscript.classList.add('active');
            tabAnalysis.classList.remove('active');
        });

        saveTranscriptButton.addEventListener('click', () => {
            let textContent = `Transcripci√≥n del Debate - Arena Pol√≠tica: Venezuela\n`;
            textContent += `====================================================\n\n`;
            chatHistory.forEach(msg => {
                const isUserModel = msg.role === 'model';
                const role = isUserModel ? (userRole === 'opposition' ? 'Gobierno' : 'Oposici√≥n') : (userRole === 'opposition' ? 'Oposici√≥n' : 'Gobierno');
                textContent += `${role}:\n${msg.parts[0].text}\n\n`;
            });
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transcripcion-debate.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function applyTheme(theme) {
            if (theme === 'light') document.body.classList.add('light-mode');
            else document.body.classList.remove('light-mode');
            themeSun.classList.toggle('hidden', theme === 'dark');
            themeMoon.classList.toggle('hidden', theme === 'light');
        }
        
        themeToggle.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-mode') ? 'dark' : 'light';
            localStorage.setItem('debateTheme', newTheme);
            applyTheme(newTheme);
        });
        applyTheme(localStorage.getItem('debateTheme') || 'dark');

        backToHomeButton.addEventListener('click', resetApp);

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'es-VE';
            recognition.interimResults = false;
            micButton.addEventListener('click', () => { recognition.start(); micButton.classList.add('mic-active'); });
            recognition.onresult = (event) => { messageInput.value = event.results[0][0].transcript; };
            recognition.onend = () => micButton.classList.remove('mic-active');
            recognition.onerror = (event) => { console.error('Error de reconocimiento de voz:', event.error); micButton.classList.remove('mic-active'); };
        } else {
            micButton.style.display = 'none';
        }
    </script>
</body>
</html>



